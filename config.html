<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GESTÃO DE METAS - ALPHALUMI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        :root {
            --primary-color: #4361ee;
            --primary-dark: #3a56d4;
            --secondary-color: #7209b7;
            --dark-bg: #121212;
            --dark-surface: #1e1e1e;
            --dark-card: #252525;
            --dark-border: #333333;
            --text-primary: #f0f0f0;
            --text-secondary: #b0b0b0;
            --success-color: #2ecc71;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --info-color: #3498db;
            --radius-md: 6px;
        }
        
        body { background-color: var(--dark-bg); color: var(--text-primary); font-family: 'Segoe UI', sans-serif; min-height: 100vh; }
        .container-main { max-width: 1400px; padding: 20px; }
        .app-header { background: linear-gradient(135deg, var(--dark-surface) 0%, var(--dark-card) 100%); border-radius: var(--radius-md); padding: 25px; margin-bottom: 30px; border-bottom: 1px solid var(--dark-border); }
        .card-dark { background-color: var(--dark-card); border: 1px solid var(--dark-border); border-radius: var(--radius-md); }
        .nav-tabs .nav-link { color: var(--text-secondary); border: none; padding: 12px 24px; }
        .nav-tabs .nav-link.active { color: var(--primary-color); background-color: var(--dark-card); border-bottom: 3px solid var(--primary-color); font-weight: 600; }
        .form-control, .form-select { background-color: var(--dark-surface); border: 1px solid var(--dark-border); color: var(--text-primary); }
        .form-control:focus { background-color: var(--dark-surface); color: white; border-color: var(--primary-color); box-shadow: none; }
        .table-dark-custom { color: var(--text-primary); }
        .table-dark-custom thead th { background-color: var(--dark-card); color: var(--text-secondary); border-bottom: 2px solid var(--dark-border); }
        
        /* Avatar Styles */
        .avatar-wrapper { position: relative; width: 60px; height: 60px; cursor: pointer; border-radius: 50%; overflow: hidden; border: 2px solid var(--primary-color); transition: transform 0.2s; }
        .avatar-wrapper:hover { transform: scale(1.1); }
        .avatar-img { width: 100%; height: 100%; object-fit: cover; }
        .avatar-placeholder { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: var(--dark-surface); color: var(--text-secondary); font-size: 1.5rem; }
        
        .notification-modal { position: fixed; top: 20px; right: 20px; z-index: 9999; display: none; width: 350px; }
        .notification-card { background: var(--dark-card); border-left: 5px solid var(--primary-color); border-radius: 4px; padding: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        .access-denied { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 80vh; }
    </style>
</head>
<body>
    <div class="container container-main">
        <div id="notificationModal" class="notification-modal">
            <div class="notification-card" id="notificationCard">
                <div class="d-flex justify-content-between align-items-start">
                    <strong id="notificationTitle">Sucesso</strong>
                    <button class="btn-close btn-close-white" onclick="hideNotification()"></button>
                </div>
                <div id="notificationMessage" class="mt-2"></div>
            </div>
        </div>

        <div id="appContainer" style="display: none;">
            <div class="app-header">
                <h1><i class="bi bi-gear-fill"></i> ADMINISTRAÇÃO ALPHALUMI</h1>
                <div class="text-secondary">Controle de Metas e Equipe</div>
            </div>

            <ul class="nav nav-tabs mb-0" id="adminTabs" role="tablist">
                <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#metas">Metas Padrão</button></li>
                <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#periodos">Períodos</button></li>
                <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#editor">Editor em Massa</button></li>
                <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#equipe" onclick="carregarEquipe()">Funcionários</button></li>
            </ul>

            <div class="tab-content card-dark p-4">
                <div class="tab-pane fade show active" id="metas">
                    <h3>Metas Gerais</h3>
                    <div id="formMetasContainer">Cargando...</div>
                </div>

                <div class="tab-pane fade" id="periodos">
                    <h3>Gerenciar Ciclos</h3>
                    <div id="listaPeriodos"></div>
                </div>

                <div class="tab-pane fade" id="editor">
                    <div class="row g-3 mb-4">
                        <div class="col-md-8">
                            <select class="form-select" id="periodoEditorSelect"></select>
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-primary w-100" onclick="carregarTabelaMassa()">Carregar Vendedores</button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-dark-custom">
                            <thead>
                                <tr>
                                    <th>Vendedor</th>
                                    <th>Meta (R$)</th>
                                    <th>Qtd Clientes</th>
                                    <th>Preço Médio</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="corpoTabelaMassa"></tbody>
                        </table>
                    </div>
                    <div class="mt-3 text-end">
                        <button class="btn btn-success" onclick="salvarTudoMassa()">Salvar Todas Alterações</button>
                    </div>
                </div>

                <div class="tab-pane fade" id="equipe">
                    <div class="table-responsive">
                        <table class="table table-dark-custom">
                            <thead>
                                <tr>
                                    <th>Avatar</th>
                                    <th>Nome</th>
                                    <th>E-mail</th>
                                    <th>Cargo</th>
                                    <th>Senha</th>
                                </tr>
                            </thead>
                            <tbody id="corpoTabelaEquipe"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="acessoNegadoContainer" class="access-denied" style="display: none;">
            <div class="card-dark p-5 text-center">
                <i class="bi bi-shield-lock-fill text-danger" style="font-size: 4rem;"></i>
                <h2 class="mt-3">Acesso Restrito</h2>
                <p>Esta página é exclusiva para administradores autorizados.</p>
                <p class="text-secondary small">Para entrar, use o parâmetro de URL correto.</p>
            </div>
        </div>
    </div>

    <script>
        // Configuração Firebase
        const fbConfig = { databaseURL: "https://bd-comercial-alpha-default-rtdb.firebaseio.com" };
        firebase.initializeApp(fbConfig);
        const db = firebase.database();

        // Segurança URL
        const params = new URLSearchParams(window.location.search);
        if (params.get('user') === 'full') {
            document.getElementById('appContainer').style.display = 'block';
        } else {
            document.getElementById('acessoNegadoContainer').style.display = 'flex';
        }

        // --- UTILITÁRIOS ---
        function notify(title, msg, type = 'success') {
            const m = document.getElementById('notificationModal');
            document.getElementById('notificationTitle').innerText = title;
            document.getElementById('notificationMessage').innerText = msg;
            m.style.display = 'block';
            setTimeout(() => m.style.display = 'none', 4000);
        }

        // --- EDITOR EM MASSA ---
        async function carregarTabelaMassa() {
            const periodo = document.getElementById('periodoEditorSelect').value;
            if(!periodo) return notify('Aviso', 'Selecione um período', 'warning');
            
            const snapshot = await db.ref(`performance_mensal/ALPHALUMI/${periodo}`).once('value');
            const funcsSnapshot = await db.ref(`funcionarios/ALPHALUMI`).once('value');
            const dados = snapshot.val() || {};
            const funcs = funcsSnapshot.val() || {};
            
            let html = '';
            Object.keys(dados).forEach(id => {
                // REGRA: Apenas permissão 'user' (vendedores)
                if(funcs[id] && funcs[id].permissao === 'user') {
                    const d = dados[id];
                    html += `
                        <tr data-id="${id}">
                            <td>${d.NOME}</td>
                            <td><input type="number" class="form-control meta-val" value="${d.META || 0}"></td>
                            <td><input type="number" class="form-control cliente-val" value="${d.limite_clientes || 0}"></td>
                            <td><input type="number" step="0.01" class="form-control preco-val" value="${d.PRECO_MEDIO || 0}"></td>
                            <td><button class="btn btn-sm btn-outline-primary" onclick="salvarLinhaMassa('${id}')">Salvar</button></td>
                        </tr>`;
                }
            });
            document.getElementById('corpoTabelaMassa').innerHTML = html;
        }

        async function salvarLinhaMassa(id) {
            const periodo = document.getElementById('periodoEditorSelect').value;
            const tr = document.querySelector(`tr[data-id="${id}"]`);
            const updates = {
                META: parseFloat(tr.querySelector('.meta-val').value),
                limite_clientes: parseInt(tr.querySelector('.cliente-val').value),
                PRECO_MEDIO: parseFloat(tr.querySelector('.preco-val').value)
            };
            
            await db.ref(`performance_mensal/ALPHALUMI/${periodo}/${id}`).update(updates);
            notify('Sucesso', 'Dados do vendedor atualizados!');
        }

        async function salvarTudoMassa() {
            const periodo = document.getElementById('periodoEditorSelect').value;
            const rows = document.querySelectorAll('#corpoTabelaMassa tr');
            const promises = Array.from(rows).map(tr => {
                const id = tr.dataset.id;
                const updates = {
                    META: parseFloat(tr.querySelector('.meta-val').value),
                    limite_clientes: parseInt(tr.querySelector('.cliente-val').value),
                    PRECO_MEDIO: parseFloat(tr.querySelector('.preco-val').value)
                };
                return db.ref(`performance_mensal/ALPHALUMI/${periodo}/${id}`).update(updates);
            });
            await Promise.all(promises);
            notify('Sucesso', 'Todas as metas foram atualizadas!');
        }

        // --- FUNCIONÁRIOS & CLOUDINARY ---
        async function carregarEquipe() {
            const snap = await db.ref('funcionarios/ALPHALUMI').once('value');
            const funcs = snap.val() || {};
            let html = '';
            
            Object.keys(funcs).forEach(id => {
                const f = funcs[id];
                const avatar = f.url_foto ? `<img src="${f.url_foto}" class="avatar-img">` : `<i class="bi bi-person-fill"></i>`;
                
                html += `
                    <tr>
                        <td>
                            <div class="avatar-wrapper" onclick="triggerUpload('${id}')">
                                <div class="avatar-placeholder" id="avatar-${id}">${avatar}</div>
                            </div>
                            <input type="file" id="file-${id}" style="display:none" onchange="uploadFoto('${id}', this)">
                        </td>
                        <td>${f.nome}</td>
                        <td>${f.email}</td>
                        <td><span class="badge bg-secondary">${f.permissao.toUpperCase()}</span></td>
                        <td>
                            <button class="btn btn-sm btn-warning" onclick="resetSenha('${id}')">Reset Pass</button>
                        </td>
                    </tr>`;
            });
            document.getElementById('corpoTabelaEquipe').innerHTML = html;
        }

        async function resetSenha(id) {
            if(confirm('Resetar senha para 123456?')) {
                await db.ref(`funcionarios/ALPHALUMI/${id}`).update({ senha_hash: "123456" });
                notify('Senha Resetada', 'O usuário agora acessa com 123456');
            }
        }

        function triggerUpload(id) { document.getElementById(`file-${id}`).click(); }

        async function uploadFoto(id, input) {
            if (!input.files || !input.files[0]) return;
            
            const file = input.files[0];
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', 'my_unsigned_preset');

            try {
                notify('Upload', 'Enviando imagem...', 'info');
                const res = await fetch('https://api.cloudinary.com/v1_1/dclhoiqdg/image/upload', {
                    method: 'POST', body: formData
                });
                const data = await res.json();
                const url = data.secure_url;

                // Atualiza nó do funcionário
                await db.ref(`funcionarios/ALPHALUMI/${id}`).update({ url_foto: url });
                
                // Atualiza no período atual se houver
                const periodoAtual = document.getElementById('periodoEditorSelect').value;
                if(periodoAtual) {
                    await db.ref(`performance_mensal/ALPHALUMI/${periodoAtual}/${id}`).update({ URL_FOTO: url });
                }

                carregarEquipe();
                notify('Sucesso', 'Foto atualizada com sucesso!');
            } catch (err) {
                notify('Erro', 'Falha no upload', 'error');
            }
        }

        // Inicialização de dropdowns
        async function init() {
            const snap = await db.ref('performance_mensal/ALPHALUMI').once('value');
            const periodos = Object.keys(snap.val() || {}).sort().reverse();
            const select = document.getElementById('periodoEditorSelect');
            periodos.forEach(p => {
                const opt = new Option(p, p);
                select.add(opt);
            });
        }
        init();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GESTÃO DE METAS - ALPHALUMI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <!-- SDK Firebase OTIMIZADO para Realtime Database público -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/cleave.js@1.6.0/dist/cleave.min.js"></script>
    <style>
        :root {
            --primary-color: #4361ee;
            --primary-dark: #3a56d4;
            --secondary-color: #7209b7;
            --dark-bg: #121212;
            --dark-surface: #1e1e1e;
            --dark-card: #252525;
            --dark-border: #333333;
            --text-primary: #f0f0f0;
            --text-secondary: #b0b0b0;
            --success-color: #2ecc71;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --info-color: #3498db;
            --radius-sm: 4px;
            --radius-md: 6px;
        }
        
        * {
            transition: background-color 0.2s ease, border-color 0.2s ease;
        }
        
        body {
            background-color: var(--dark-bg);
            color: var(--text-primary);
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            min-height: 100vh;
        }
        
        .container-main {
            max-width: 1400px;
            padding: 20px;
        }
        
        .app-header {
            border-bottom: 1px solid var(--dark-border);
            padding-bottom: 20px;
            margin-bottom: 30px;
            background: linear-gradient(135deg, var(--dark-surface) 0%, var(--dark-card) 100%);
            border-radius: var(--radius-md);
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .app-header h1 {
            color: var(--text-primary);
            font-weight: 600;
            font-size: 2.2rem;
            margin-bottom: 5px;
        }
        
        .app-header .subtitle {
            color: var(--text-secondary);
            font-size: 1rem;
        }
        
        .card-dark {
            background-color: var(--dark-card);
            border: 1px solid var(--dark-border);
            border-radius: var(--radius-md);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .tab-pane {
            padding: 25px;
        }
        
        .nav-tabs {
            border-bottom: 1px solid var(--dark-border);
            margin-bottom: 0;
        }
        
        .nav-tabs .nav-link {
            color: var(--text-secondary);
            background-color: transparent;
            border: 1px solid transparent;
            border-radius: var(--radius-md) var(--radius-md) 0 0;
            padding: 12px 24px;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .nav-tabs .nav-link:hover {
            color: var(--text-primary);
            border-color: var(--dark-border) var(--dark-border) var(--dark-border);
            background-color: rgba(255, 255, 255, 0.05);
        }
        
        .nav-tabs .nav-link.active {
            color: var(--primary-color);
            background-color: var(--dark-card);
            border-color: var(--dark-border) var(--dark-border) var(--dark-card);
            font-weight: 600;
        }
        
        .form-label {
            color: var(--text-secondary);
            font-weight: 500;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }
        
        .form-control, .form-select {
            background-color: var(--dark-surface);
            border: 1px solid var(--dark-border);
            color: var(--text-primary);
            border-radius: var(--radius-sm);
            padding: 10px 12px;
        }
        
        .form-control:focus, .form-select:focus {
            background-color: var(--dark-surface);
            border-color: var(--primary-color);
            color: var(--text-primary);
            box-shadow: 0 0 0 0.2rem rgba(67, 97, 238, 0.25);
        }
        
        .btn {
            border-radius: var(--radius-sm);
            font-weight: 500;
            padding: 10px 20px;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .btn-primary:hover, .btn-primary:focus {
            background-color: var(--primary-dark);
            border-color: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .btn-success {
            background-color: var(--success-color);
            border-color: var(--success-color);
        }
        
        .btn-danger {
            background-color: var(--danger-color);
            border-color: var(--danger-color);
        }
        
        .btn-outline-secondary {
            color: var(--text-secondary);
            border-color: var(--dark-border);
        }
        
        .btn-outline-secondary:hover {
            background-color: var(--dark-border);
            border-color: var(--dark-border);
            color: var(--text-primary);
        }
        
        .table-responsive {
            border-radius: var(--radius-md);
            overflow: hidden;
            border: 1px solid var(--dark-border);
        }
        
        .table-dark-custom {
            background-color: var(--dark-surface);
            color: var(--text-primary);
            margin-bottom: 0;
        }
        
        .table-dark-custom thead th {
            background-color: var(--dark-card);
            border-bottom: 2px solid var(--dark-border);
            color: var(--text-secondary);
            font-weight: 600;
            padding: 15px;
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 0.5px;
        }
        
        .table-dark-custom tbody td {
            border-top: 1px solid var(--dark-border);
            padding: 12px 15px;
            vertical-align: middle;
        }
        
        .table-dark-custom tbody tr:hover {
            background-color: rgba(255, 255, 255, 0.03);
        }
        
        .list-group-item-dark {
            background-color: var(--dark-surface);
            color: var(--text-primary);
            border: 1px solid var(--dark-border);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: var(--radius-sm);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        
        .list-group-item-dark:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }
        
        .list-group-item-dark.selected {
            background-color: rgba(67, 97, 238, 0.15);
            border-color: var(--primary-color);
        }
        
        .periodo-container {
            background-color: var(--dark-surface);
            border: 1px solid var(--dark-border);
            border-radius: var(--radius-md);
            padding: 20px;
            margin-bottom: 15px;
        }
        
        .periodo-container.active {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 1px var(--primary-color);
        }
        
        .periodo-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--dark-border);
        }
        
        .periodo-title {
            font-weight: 600;
            font-size: 1.1rem;
        }
        
        .badge-custom {
            background-color: var(--primary-color);
            color: white;
            padding: 5px 10px;
            border-radius: var(--radius-sm);
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        /* Modal de notificação personalizado */
        .notification-modal {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 400px;
            width: 90%;
            display: none;
        }
        
        .notification-card {
            background-color: var(--dark-card);
            border-radius: var(--radius-md);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            border-left: 4px solid var(--primary-color);
        }
        
        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid var(--dark-border);
        }
        
        .notification-title {
            font-weight: 600;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .notification-body {
            padding: 20px;
        }
        
        .notification-success {
            border-left-color: var(--success-color);
        }
        
        .notification-error {
            border-left-color: var(--danger-color);
        }
        
        .notification-warning {
            border-left-color: var(--warning-color);
        }
        
        .notification-info {
            border-left-color: var(--info-color);
        }
        
        .btn-close-custom {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }
        
        .btn-close-custom:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }
        
        /* Acesso negado */
        .access-denied {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 70vh;
            text-align: center;
        }
        
        .access-denied h2 {
            color: var(--danger-color);
            margin-bottom: 15px;
        }
        
        .access-denied p {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }
        
        /* Input com prefixo */
        .input-group-prefix {
            position: relative;
        }
        
        .input-group-prefix .prefix {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            pointer-events: none;
            z-index: 5;
        }
        
        .input-group-prefix .form-control {
            padding-left: 35px;
        }
        
        .input-group-suffix .suffix {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            pointer-events: none;
            z-index: 5;
        }
        
        .input-group-suffix .form-control {
            padding-right: 35px;
        }
        
        /* Avatar circular */
        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--dark-border);
        }
        
        .avatar-upload {
            position: relative;
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 2px dashed var(--dark-border);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            overflow: hidden;
        }
        
        .avatar-upload:hover {
            border-color: var(--primary-color);
        }
        
        .avatar-upload img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .avatar-upload input {
            display: none;
        }
        
        .avatar-upload-label {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            text-align: center;
            padding: 5px;
            font-size: 0.8rem;
        }
        
        /* Totalizador tabela */
        .tabela-totalizador {
            background-color: var(--dark-card);
            border-top: 2px solid var(--primary-color);
            font-weight: 600;
        }
        
        .tabela-totalizador td {
            padding: 12px 15px;
        }
        
        /* Tags para permissões */
        .permissao-tag {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .permissao-user {
            background-color: rgba(52, 152, 219, 0.2);
            color: #3498db;
        }
        
        .permissao-ger {
            background-color: rgba(46, 204, 113, 0.2);
            color: #2ecc71;
        }
        
        .permissao-adm {
            background-color: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
        }
        
        /* Responsividade */
        @media (max-width: 768px) {
            .container-main {
                padding: 15px;
            }
            
            .app-header {
                padding: 20px;
            }
            
            .app-header h1 {
                font-size: 1.8rem;
            }
            
            .nav-tabs .nav-link {
                padding: 10px 15px;
                font-size: 0.9rem;
            }
            
            .tab-pane {
                padding: 20px 15px;
            }
            
            .table-dark-custom thead th,
            .table-dark-custom tbody td {
                padding: 10px;
                font-size: 0.9rem;
            }
            
            .notification-modal {
                left: 5%;
                right: 5%;
                max-width: 90%;
            }
        }
        
        @media (max-width: 576px) {
            .btn {
                width: 100%;
                margin-bottom: 10px;
            }
            
            .d-flex.gap-2 {
                flex-direction: column;
            }
            
            .nav-tabs {
                flex-wrap: nowrap;
                overflow-x: auto;
                white-space: nowrap;
            }
            
            .table-responsive {
                font-size: 0.85rem;
            }
        }
        
        /* Animações */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        
        .slide-in-right {
            animation: slideInRight 0.3s ease-out;
        }
        
        /* Estilos para o reset de senha */
        .btn-reset {
            padding: 5px 10px;
            font-size: 0.85rem;
        }
        
        .btn-reset.active {
            background-color: var(--success-color);
            border-color: var(--success-color);
        }
        
        /* Estilos para a tabela de usuários inline */
        .usuario-input {
            background-color: var(--dark-surface);
            border: 1px solid var(--dark-border);
            color: var(--text-primary);
            border-radius: var(--radius-sm);
            padding: 6px 10px;
            width: 100%;
            font-size: 0.9rem;
        }
        
        .usuario-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        .usuario-select {
            background-color: var(--dark-surface);
            border: 1px solid var(--dark-border);
            color: var(--text-primary);
            border-radius: var(--radius-sm);
            padding: 6px 10px;
            width: 100%;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="container container-main">
        <!-- Modal de notificação -->
        <div id="notificationModal" class="notification-modal">
            <div class="notification-card" id="notificationCard">
                <div class="notification-header">
                    <div class="notification-title" id="notificationTitle">
                        <i class="bi bi-check-circle-fill"></i> Sucesso
                    </div>
                    <button type="button" class="btn-close-custom" onclick="hideNotification()">
                        <i class="bi bi-x"></i>
                    </button>
                </div>
                <div class="notification-body">
                    <p id="notificationMessage">Mensagem de notificação</p>
                </div>
            </div>
        </div>

        <!-- Modal de upload de foto -->
        <div class="modal fade" id="modalUploadFoto" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content card-dark">
                    <div class="modal-header border-dark">
                        <h5 class="modal-title">Upload de Foto</h5>
                        <button type="button" class="btn-close-custom" data-bs-dismiss="modal">
                            <i class="bi bi-x"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div id="avatarUploadContainer" class="d-flex justify-content-center mb-4">
                            <div class="avatar-upload" onclick="document.getElementById('fileInput').click()">
                                <img id="avatarPreview" src="" alt="Preview" style="display: none;">
                                <div id="avatarPlaceholder" class="d-flex flex-column align-items-center justify-content-center">
                                    <i class="bi bi-camera" style="font-size: 2rem; color: var(--text-secondary);"></i>
                                    <small class="mt-2 text-secondary">Clique para selecionar</small>
                                </div>
                                <input type="file" id="fileInput" accept="image/*" onchange="previewImage(this)">
                            </div>
                        </div>
                        <div class="progress mb-3" style="height: 6px; display: none;" id="uploadProgressContainer">
                            <div id="uploadProgress" class="progress-bar" role="progressbar" style="width: 0%"></div>
                        </div>
                        <div id="uploadStatus" class="text-center"></div>
                    </div>
                    <div class="modal-footer border-dark">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                            Cancelar
                        </button>
                        <button type="button" class="btn btn-primary" onclick="uploadToCloudinary()" id="btnUpload">
                            Upload
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- CONTAINER PRINCIPAL (SÓ EXIBIDO SE AUTORIZADO) -->
        <div id="appContainer" style="display: none;">
            <div class="app-header fade-in">
                <h1><i class="bi bi-graph-up-arrow"></i> GESTÃO DE METAS</h1>
                <div class="subtitle">ALPHALUMI - Painel Administrativo</div>
            </div>

            <ul class="nav nav-tabs" id="abasAdmin" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="aba-metas" data-bs-toggle="tab" data-bs-target="#metas" type="button">
                        <i class="bi bi-sliders"></i> Metas Padrão
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="aba-periodos" data-bs-toggle="tab" data-bs-target="#periodos" type="button">
                        <i class="bi bi-calendar-range"></i> Períodos
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="aba-editor" data-bs-toggle="tab" data-bs-target="#editor" type="button">
                        <i class="bi bi-table"></i> Editor em Massa
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="aba-usuarios" data-bs-toggle="tab" data-bs-target="#usuarios" type="button">
                        <i class="bi bi-people"></i> Controle de Usuários
                    </button>
                </li>
            </ul>

            <div class="tab-content card-dark" id="abasAdminConteudo">
                <!-- ABA 1: METAS PADRÃO -->
                <div class="tab-pane fade show active" id="metas" role="tabpanel">
                    <h3 class="mb-4"><i class="bi bi-sliders"></i> Editar Metas Padrão</h3>
                    <form id="formMetasPadrao">
                        <div class="row g-3 mb-4">
                            <div class="col-md-4">
                                <label class="form-label">META (R$)</label>
                                <div class="input-group-prefix">
                                    <span class="prefix">R$</span>
                                    <input type="text" class="form-control money-input" id="inputMeta" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">META_CLIENTE</label>
                                <input type="number" step="1" class="form-control" id="inputMetaCliente" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">META_PRECO (R$)</label>
                                <div class="input-group-prefix">
                                    <span class="prefix">R$</span>
                                    <input type="text" class="form-control money-input" id="inputMetaPreco" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">META_FUME_MAX (R$)</label>
                                <div class="input-group-prefix">
                                    <span class="prefix">R$</span>
                                    <input type="text" class="form-control money-input" id="inputMetaFumeMax" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">PERCENT_15D</label>
                                <div class="input-group-suffix">
                                    <input type="text" class="form-control percent-input" id="inputPercent15D" required>
                                    <span class="suffix">%</span>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">PERCENT_DEVOLUCAO</label>
                                <div class="input-group-suffix">
                                    <input type="text" class="form-control percent-input" id="inputPercentDevolucao" required>
                                    <span class="suffix">%</span>
                                </div>
                            </div>
                        </div>
                        <div class="d-flex flex-wrap gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-save"></i> Salvar Metas Padrão
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="carregarMetasPadrao()">
                                <i class="bi bi-arrow-clockwise"></i> Carregar Valores Atuais
                            </button>
                        </div>
                    </form>
                </div>

                <!-- ABA 2: PERÍODOS -->
                <div class="tab-pane fade" id="periodos" role="tabpanel">
                    <h3 class="mb-4"><i class="bi bi-calendar-range"></i> Gerenciar Períodos</h3>
                    <div class="mb-4">
                        <button class="btn btn-success mb-2" onclick="criarInterfaceNovoPeriodo()">
                            <i class="bi bi-plus-circle"></i> Criar Novo Período
                        </button>
                        <button class="btn btn-outline-secondary mb-2" onclick="carregarListaPeriodos()">
                            <i class="bi bi-arrow-clockwise"></i> Atualizar Lista
                        </button>
                    </div>
                    
                    <div id="containerListaPeriodos" class="mb-4">
                        <div class="card-dark p-3">
                            <p class="mb-0 text-center">Carregando lista de períodos...</p>
                        </div>
                    </div>
                </div>

                <!-- ABA 3: EDITOR EM MASSA -->
                <div class="tab-pane fade" id="editor" role="tabpanel">
                    <h3 class="mb-4"><i class="bi bi-table"></i> Editor em Massa de Metas por Vendedor</h3>
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label class="form-label">Selecionar Período:</label>
                            <select class="form-select" id="seletorPeriodoEditor">
                                <option value="">-- Selecione um período --</option>
                            </select>
                        </div>
                        <div class="col-md-6 d-flex align-items-end">
                            <button class="btn btn-primary w-100" onclick="carregarMetasPeriodo()" id="btnCarregarMetas">
                                <i class="bi bi-cloud-download"></i> Carregar Metas
                            </button>
                        </div>
                    </div>
                    <div id="containerTabelaEditor" class="card-dark p-3">
                        <p class="mb-0 text-center text-secondary">Selecione um período e clique em "Carregar Metas" para editar os valores.</p>
                    </div>
                </div>

                <!-- ABA 4: CONTROLE DE USUÁRIOS -->
                <div class="tab-pane fade" id="usuarios" role="tabpanel">
                    <h3 class="mb-4"><i class="bi bi-people"></i> Controle de Usuários</h3>
                    
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="input-group">
                                <input type="text" class="form-control" id="inputBuscaUsuario" placeholder="Buscar por nome, email ou ID...">
                                <button class="btn btn-outline-secondary" type="button" onclick="buscarUsuarios()">
                                    <i class="bi bi-search"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-6 d-flex justify-content-end">
                            <button class="btn btn-success" onclick="criarNovoUsuario()">
                                <i class="bi bi-person-plus"></i> Novo Usuário
                            </button>
                            <button class="btn btn-primary ms-2" onclick="salvarTodosUsuarios()" id="btnSalvarTodos">
                                <i class="bi bi-save-all"></i> Salvar Todos
                            </button>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-dark-custom">
                            <thead>
                                <tr>
                                    <th style="width: 60px;">Foto</th>
                                    <th style="width: 70px;">ID</th>
                                    <th style="width: 200px;">Nome</th>
                                    <th style="width: 200px;">Email/Login</th>
                                    <th style="width: 100px;">Senha</th>
                                    <th style="width: 100px;">Permissão</th>
                                    <th style="width: 100px;">Estado/UF</th>
                                    <th style="width: 100px;">Meta (R$)</th>
                                    <th style="width: 100px;">Ação</th>
                                </tr>
                            </thead>
                            <tbody id="tabelaUsuarios">
                                <tr>
                                    <td colspan="9" class="text-center py-4">
                                        <div class="spinner-border spinner-border-sm text-secondary me-2" role="status"></div>
                                        Carregando usuários...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Modal para novo usuário -->
                    <div class="modal fade" id="modalNovoUsuario" tabindex="-1" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content card-dark">
                                <div class="modal-header border-dark">
                                    <h5 class="modal-title">Novo Usuário</h5>
                                    <button type="button" class="btn-close-custom" data-bs-dismiss="modal">
                                        <i class="bi bi-x"></i>
                                    </button>
                                </div>
                                <div class="modal-body">
                                    <form id="formNovoUsuario">
                                        <div class="row g-3">
                                            <div class="col-md-6">
                                                <label class="form-label">ID do Funcionário *</label>
                                                <input type="number" class="form-control" id="novoUsuarioId" required>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Nome Completo *</label>
                                                <input type="text" class="form-control" id="novoUsuarioNome" required>
                                            </div>
                                            
                                            <div class="col-md-12">
                                                <label class="form-label">Email/Login *</label>
                                                <input type="email" class="form-control" id="novoUsuarioEmail" required>
                                            </div>
                                            
                                            <div class="col-md-6">
                                                <label class="form-label">Permissão *</label>
                                                <select class="form-select" id="novoUsuarioPermissao" required>
                                                    <option value="user">USER</option>
                                                    <option value="ger">GER</option>
                                                    <option value="adm">ADM</option>
                                                </select>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Estado/UF</label>
                                                <input type="text" class="form-control" id="novoUsuarioUf" placeholder="PR" maxlength="2">
                                            </div>
                                            
                                            <div class="col-md-12">
                                                <label class="form-label">Meta (R$)</label>
                                                <div class="input-group-prefix">
                                                    <span class="prefix">R$</span>
                                                    <input type="text" class="form-control money-input" id="novoUsuarioMeta">
                                                </div>
                                            </div>
                                            
                                            <div class="col-md-12">
                                                <label class="form-label">Foto do Perfil</label>
                                                <div class="avatar-upload mb-2" onclick="document.getElementById('novoFileInput').click()">
                                                    <img id="novoAvatarPreview" src="" alt="Preview" style="display: none;">
                                                    <div id="novoAvatarPlaceholder" class="d-flex flex-column align-items-center justify-content-center">
                                                        <i class="bi bi-camera" style="font-size: 2rem; color: var(--text-secondary);"></i>
                                                        <small class="mt-2 text-secondary">Clique para selecionar foto</small>
                                                    </div>
                                                    <input type="file" id="novoFileInput" accept="image/*" onchange="previewNovoImage(this)" style="display: none;">
                                                </div>
                                                <small class="text-secondary">A foto será enviada automaticamente para o Cloudinary</small>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                                <div class="modal-footer border-dark">
                                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                                        <i class="bi bi-x-circle"></i> Cancelar
                                    </button>
                                    <button type="button" class="btn btn-primary" onclick="salvarNovoUsuario()">
                                        <i class="bi bi-save"></i> Salvar Usuário
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- MENSAGEM DE ACESSO NEGADO -->
        <div id="acessoNegadoContainer" class="access-denied" style="display: none;">
            <div class="card-dark p-5 text-center">
                <div class="mb-4">
                    <i class="bi bi-shield-lock-fill" style="font-size: 4rem; color: var(--danger-color);"></i>
                </div>
                <h2>Perfil não autorizado</h2>
                <p class="mb-4">Acesso requer autorização específica.</p>
                <button class="btn btn-outline-secondary" onclick="window.location.href='/'">
                    <i class="bi bi-arrow-left"></i> Voltar
                </button>
            </div>
        </div>
    </div>

    <script>
        // ==================== VERIFICAÇÃO DE PARÂMETRO DE URL ====================
        const urlParams = new URLSearchParams(window.location.search);
        const userParam = urlParams.get('user');
        const acessoAutorizado = (userParam === 'full');
        
        if (acessoAutorizado) {
            document.getElementById('appContainer').style.display = 'block';
        } else {
            document.getElementById('acessoNegadoContainer').style.display = 'block';
            throw new Error("Acesso não autorizado");
        }

        // ==================== SISTEMA DE NOTIFICAÇÃO ====================
        function mostrarNotificacao(titulo, mensagem, tipo = 'success') {
            const modal = document.getElementById('notificationModal');
            const card = document.getElementById('notificationCard');
            const titleElement = document.getElementById('notificationTitle');
            const messageElement = document.getElementById('notificationMessage');
            
            card.classList.remove('notification-success', 'notification-error', 'notification-warning', 'notification-info');
            
            let iconClass = 'bi-info-circle-fill';
            let typeClass = 'notification-info';
            
            switch(tipo) {
                case 'success':
                    iconClass = 'bi-check-circle-fill';
                    typeClass = 'notification-success';
                    break;
                case 'error':
                    iconClass = 'bi-exclamation-circle-fill';
                    typeClass = 'notification-error';
                    break;
                case 'warning':
                    iconClass = 'bi-exclamation-triangle-fill';
                    typeClass = 'notification-warning';
                    break;
                case 'info':
                    iconClass = 'bi-info-circle-fill';
                    typeClass = 'notification-info';
                    break;
            }
            
            card.classList.add(typeClass);
            titleElement.innerHTML = `<i class="bi ${iconClass}"></i> ${titulo}`;
            messageElement.textContent = mensagem;
            
            modal.style.display = 'block';
            modal.classList.add('slide-in-right');
            
            setTimeout(() => {
                hideNotification();
            }, 5000);
        }
        
        function hideNotification() {
            const modal = document.getElementById('notificationModal');
            modal.style.display = 'none';
            modal.classList.remove('slide-in-right');
        }

        // ==================== CONFIGURAÇÃO FIREBASE PÚBLICO ====================
        const firebaseConfig = {
            apiKey: "dummy-key-for-public-db",
            authDomain: "none",
            databaseURL: "https://bd-comercial-alpha-default-rtdb.firebaseio.com",
            projectId: "bd-comercial-alpha",
            storageBucket: "none",
            messagingSenderId: "none",
            appId: "none"
        };
        
        let app;
        let database;
        
        try {
            if (!firebase.apps.length) {
                app = firebase.initializeApp(firebaseConfig);
            } else {
                app = firebase.app();
            }
            database = firebase.database();
            console.log("Firebase inicializado com sucesso!");
            
            // ==================== VARIÁVEIS GLOBAIS ====================
            let usuarioAtualUpload = null;
            let arquivoParaUpload = null;
            let arquivoParaUploadNovo = null;
            
            // ==================== FUNÇÕES AUXILIARES ====================
            function inicializarMascaras() {
                document.querySelectorAll('.money-input').forEach(input => {
                    new Cleave(input, {
                        numeral: true,
                        numeralThousandsGroupStyle: 'thousand',
                        numeralDecimalMark: ',',
                        delimiter: '.',
                        numeralDecimalScale: 2,
                        prefix: '',
                        rawValueTrimPrefix: true
                    });
                });
                
                document.querySelectorAll('.percent-input').forEach(input => {
                    new Cleave(input, {
                        numeral: true,
                        numeralThousandsGroupStyle: 'thousand',
                        numeralDecimalMark: ',',
                        delimiter: '.',
                        numeralDecimalScale: 2,
                        suffix: '',
                        rawValueTrimSuffix: true
                    });
                });
            }
            
            function formatarParaNumero(valorFormatado) {
                if (!valorFormatado) return 0;
                return parseFloat(valorFormatado.toString()
                    .replace('R$', '')
                    .replace(/\./g, '')
                    .replace(',', '.')
                    .trim()) || 0;
            }
            
            function formatarPercentualParaNumero(valorFormatado) {
                if (!valorFormatado) return 0;
                const valor = valorFormatado.toString().replace('%', '').trim();
                return parseFloat(valor.replace(',', '.')) || 0;
            }
            
            function formatarNumeroParaExibicao(valorNumerico) {
                if (!valorNumerico && valorNumerico !== 0) return '';
                return valorNumerico.toString().replace('.', ',');
            }
            
            function formatarMetaParaExibicao(valorNumerico) {
                if (!valorNumerico && valorNumerico !== 0) return '';
                return `R$ ${valorNumerico.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            }
            
            function mostrarStatus(mensagem, isErro = false) {
                const tipo = isErro ? 'error' : 'success';
                const titulo = isErro ? 'Erro' : 'Sucesso';
                mostrarNotificacao(titulo, mensagem, tipo);
            }
            
            // ==================== UPLOAD CLOUDINARY ====================
            function previewImage(input) {
                if (input.files && input.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        document.getElementById('avatarPreview').src = e.target.result;
                        document.getElementById('avatarPreview').style.display = 'block';
                        document.getElementById('avatarPlaceholder').style.display = 'none';
                    };
                    reader.readAsDataURL(input.files[0]);
                    arquivoParaUpload = input.files[0];
                }
            }
            
            function previewNovoImage(input) {
                if (input.files && input.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        document.getElementById('novoAvatarPreview').src = e.target.result;
                        document.getElementById('novoAvatarPreview').style.display = 'block';
                        document.getElementById('novoAvatarPlaceholder').style.display = 'none';
                    };
                    reader.readAsDataURL(input.files[0]);
                    arquivoParaUploadNovo = input.files[0];
                }
            }
            
            function uploadToCloudinary() {
                if (!arquivoParaUpload || !usuarioAtualUpload) {
                    mostrarStatus('Selecione uma imagem primeiro!', true);
                    return;
                }
                
                const formData = new FormData();
                formData.append('file', arquivoParaUpload);
                formData.append('upload_preset', 'my_unsigned_preset');
                formData.append('cloud_name', 'dclhoiqdg');
                
                const xhr = new XMLHttpRequest();
                
                xhr.upload.addEventListener('progress', function(e) {
                    if (e.lengthComputable) {
                        const percentComplete = (e.loaded / e.total) * 100;
                        document.getElementById('uploadProgress').style.width = percentComplete + '%';
                        document.getElementById('uploadProgressContainer').style.display = 'block';
                    }
                });
                
                xhr.addEventListener('load', function() {
                    if (xhr.status === 200) {
                        const response = JSON.parse(xhr.responseText);
                        const imageUrl = response.secure_url;
                        
                        // Atualizar no Firebase
                        database.ref(`funcionarios/ALPHALUMI/${usuarioAtualUpload.id}/url_foto`).set(imageUrl)
                            .then(() => {
                                mostrarStatus('Foto atualizada com sucesso!');
                                document.getElementById(`avatar-${usuarioAtualUpload.id}`).src = imageUrl;
                                usuarioAtualUpload.url_foto = imageUrl;
                                
                                // Fechar modal
                                bootstrap.Modal.getInstance(document.getElementById('modalUploadFoto')).hide();
                                
                                // Resetar upload
                                document.getElementById('avatarPreview').src = '';
                                document.getElementById('avatarPreview').style.display = 'none';
                                document.getElementById('avatarPlaceholder').style.display = 'block';
                                document.getElementById('uploadProgressContainer').style.display = 'none';
                                document.getElementById('uploadProgress').style.width = '0%';
                                document.getElementById('fileInput').value = '';
                                arquivoParaUpload = null;
                            })
                            .catch(error => {
                                console.error("Erro ao salvar URL:", error);
                                mostrarStatus('Erro ao salvar URL: ' + error.message, true);
                            });
                    } else {
                        mostrarStatus('Erro no upload: ' + xhr.statusText, true);
                    }
                });
                
                xhr.addEventListener('error', function() {
                    mostrarStatus('Erro na conexão com o Cloudinary', true);
                });
                
                xhr.open('POST', 'https://api.cloudinary.com/v1_1/dclhoiqdg/image/upload');
                xhr.send(formData);
            }
            
            function abrirUploadFoto(usuario) {
                usuarioAtualUpload = usuario;
                arquivoParaUpload = null;
                
                document.getElementById('avatarPreview').src = '';
                document.getElementById('avatarPreview').style.display = 'none';
                document.getElementById('avatarPlaceholder').style.display = 'block';
                document.getElementById('uploadProgressContainer').style.display = 'none';
                document.getElementById('uploadProgress').style.width = '0%';
                document.getElementById('fileInput').value = '';
                
                const modal = new bootstrap.Modal(document.getElementById('modalUploadFoto'));
                modal.show();
            }
            
            // ==================== ABA 1: METAS PADRÃO ====================
            const CAMINHO_METAS = 'empresas/ALPHALUMI/METAS';

            function carregarMetasPadrao() {
                console.log("Carregando metas padrão...");
                database.ref(CAMINHO_METAS).get().then((snapshot) => {
                    console.log("Dados recebidos:", snapshot.val());
                    if (snapshot.exists()) {
                        const data = snapshot.val();
                        
                        // Encontrar e atualizar cada input
                        document.querySelectorAll('.money-input').forEach(input => {
                            const id = input.id;
                            let valor = 0;
                            
                            switch(id) {
                                case 'inputMeta':
                                    valor = data.META || 0;
                                    break;
                                case 'inputMetaPreco':
                                    valor = data.META_PRECO || data.PRECO_MEDIO || 0;
                                    break;
                                case 'inputMetaFumeMax':
                                    valor = data.META_FUME_MAX || 0;
                                    break;
                            }
                            
                            input.value = valor ? valor.toString().replace('.', ',') : '';
                        });
                        
                        document.querySelectorAll('.percent-input').forEach(input => {
                            const id = input.id;
                            let valor = 0;
                            
                            switch(id) {
                                case 'inputPercent15D':
                                    valor = data.PERCENT_15D || 0;
                                    break;
                                case 'inputPercentDevolucao':
                                    valor = data.PERCENT_DEVOLUCAO || 0;
                                    break;
                            }
                            
                            // Converter decimal para percentual (0.65 -> 65)
                            input.value = valor ? (valor * 100).toFixed(2).replace('.', ',') : '';
                        });
                        
                        document.getElementById('inputMetaCliente').value = data.META_CLIENTE || data.limite_clientes || '';
                        
                        mostrarStatus('Metas padrão carregadas com sucesso!');
                    } else {
                        mostrarStatus('Nenhuma meta padrão encontrada.', true);
                    }
                }).catch((error) => {
                    console.error("Erro ao carregar metas:", error);
                    mostrarStatus('Erro ao carregar: ' + error.message, true);
                });
            }

            document.getElementById('formMetasPadrao').addEventListener('submit', (e) => {
                e.preventDefault();
                
                const dadosAtualizados = {
                    META: formatarParaNumero(document.getElementById('inputMeta').value),
                    META_CLIENTE: parseFloat(document.getElementById('inputMetaCliente').value) || 0,
                    META_PRECO: formatarParaNumero(document.getElementById('inputMetaPreco').value),
                    META_FUME_MAX: formatarParaNumero(document.getElementById('inputMetaFumeMax').value),
                    PERCENT_15D: formatarPercentualParaNumero(document.getElementById('inputPercent15D').value) / 100,
                    PERCENT_DEVOLUCAO: formatarPercentualParaNumero(document.getElementById('inputPercentDevolucao').value) / 100
                };
                
                console.log("Dados a serem salvos:", dadosAtualizados);
                
                database.ref(CAMINHO_METAS).update(dadosAtualizados)
                    .then(() => {
                        mostrarStatus('Metas padrão salvas com sucesso!');
                        console.log("Metas salvas:", dadosAtualizados);
                    })
                    .catch((error) => {
                        console.error("Erro ao salvar:", error);
                        mostrarStatus('Erro ao salvar: ' + error.message, true);
                    });
            });

            // ==================== ABA 2: PERÍODOS ====================
            function carregarListaPeriodos() {
                console.log("Carregando lista de períodos...");
                database.ref('performance_mensal/ALPHALUMI').get().then((snapshot) => {
                    console.log("Períodos recebidos:", snapshot.val());
                    const container = document.getElementById('containerListaPeriodos');
                    
                    if (snapshot.exists()) {
                        const periodos = Object.keys(snapshot.val());
                        periodos.sort().reverse();
                        
                        if (periodos.length === 0) {
                            container.innerHTML = '<div class="card-dark p-3"><p class="mb-0 text-center">Nenhum período encontrado.</p></div>';
                            return;
                        }
                        
                        let html = '<h5 class="mb-3">Períodos Existentes:</h5>';
                        
                        periodos.forEach(chavePeriodo => {
                            html += `
                                <div class="periodo-container" id="periodo-${chavePeriodo}">
                                    <div class="periodo-header">
                                        <div class="periodo-title">${chavePeriodo}</div>
                                        <button class="btn btn-sm btn-primary" onclick="abrirEdicaoPeriodo('${chavePeriodo}')">
                                            <i class="bi bi-pencil"></i> Editar
                                        </button>
                                    </div>
                                    <div id="periodo-form-${chavePeriodo}" style="display: none;">
                                        <form onsubmit="salvarPeriodo('${chavePeriodo}'); return false;">
                                            <div class="row g-3">
                                                <div class="col-md-6">
                                                    <label class="form-label">DIA_META_INICIO</label>
                                                    <input type="date" class="form-control" id="editDiaInicio-${chavePeriodo}" required>
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label">DIA_META_FIM</label>
                                                    <input type="date" class="form-control" id="editDiaFim-${chavePeriodo}" required>
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label">DIA_META_15D</label>
                                                    <input type="date" class="form-control" id="editDia15d-${chavePeriodo}" required>
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label">DIAS_UTEIS</label>
                                                    <input type="number" class="form-control" id="editDiasUteis-${chavePeriodo}" required>
                                                </div>
                                                <div class="col-md-12">
                                                    <label class="form-label">PRODUTOS_FILTRO (separados por vírgula)</label>
                                                    <input type="text" class="form-control" id="editProdutosFiltro-${chavePeriodo}" placeholder="Ex: produto1,produto2,produto3">
                                                </div>
                                                <div class="col-md-12">
                                                    <div class="d-flex flex-wrap gap-2">
                                                        <button type="submit" class="btn btn-primary">
                                                            <i class="bi bi-save"></i> Salvar
                                                        </button>
                                                        <button type="button" class="btn btn-danger" onclick="excluirPeriodo('${chavePeriodo}')">
                                                            <i class="bi bi-trash"></i> Excluir
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            `;
                        });
                        
                        container.innerHTML = html;
                        mostrarStatus(`${periodos.length} período(s) carregado(s).`);
                    } else {
                        container.innerHTML = '<div class="card-dark p-3"><p class="mb-0 text-center">Nenhum período encontrado no banco de dados.</p></div>';
                    }
                }).catch((error) => {
                    console.error("Erro ao carregar períodos:", error);
                    mostrarStatus('Erro ao carregar lista: ' + error.message, true);
                });
            }

            window.abrirEdicaoPeriodo = function(chavePeriodo) {
                // Remover classe active de todos os containers
                document.querySelectorAll('.periodo-container').forEach(container => {
                    container.classList.remove('active');
                });
                
                // Adicionar classe active ao container selecionado
                const container = document.getElementById(`periodo-${chavePeriodo}`);
                container.classList.add('active');
                
                const formContainer = document.getElementById(`periodo-form-${chavePeriodo}`);
                
                // Alternar visibilidade
                if (formContainer.style.display === 'none') {
                    formContainer.style.display = 'block';
                    
                    // Carregar dados se ainda não carregados
                    if (!formContainer.dataset.carregado) {
                        database.ref(`performance_mensal/ALPHALUMI/${chavePeriodo}`).get().then((snapshot) => {
                            if (snapshot.exists()) {
                                const dados = snapshot.val();
                                const params = dados.parametros_do_periodo || {};
                                
                                document.getElementById(`editDiaInicio-${chavePeriodo}`).value = params.DIA_META_INICIO || '';
                                document.getElementById(`editDiaFim-${chavePeriodo}`).value = params.DIA_META_FIM || '';
                                document.getElementById(`editDia15d-${chavePeriodo}`).value = params.DIA_META_15D || '';
                                document.getElementById(`editDiasUteis-${chavePeriodo}`).value = params.DIAS_UTEIS || 0;
                                document.getElementById(`editProdutosFiltro-${chavePeriodo}`).value = params.PRODUTOS_FILTRO || '';
                                
                                formContainer.dataset.carregado = true;
                            }
                        }).catch((error) => {
                            console.error("Erro ao carregar período:", error);
                            mostrarStatus('Erro ao carregar: ' + error.message, true);
                        });
                    }
                } else {
                    formContainer.style.display = 'none';
                    container.classList.remove('active');
                }
            };

            window.salvarPeriodo = function(chavePeriodo) {
                const dadosAtualizados = {
                    parametros_do_periodo: {
                        DIA_META_INICIO: document.getElementById(`editDiaInicio-${chavePeriodo}`).value,
                        DIA_META_FIM: document.getElementById(`editDiaFim-${chavePeriodo}`).value,
                        DIA_META_15D: document.getElementById(`editDia15d-${chavePeriodo}`).value,
                        DIAS_UTEIS: parseInt(document.getElementById(`editDiasUteis-${chavePeriodo}`).value) || 0,
                        PRODUTOS_FILTRO: document.getElementById(`editProdutosFiltro-${chavePeriodo}`).value || "",
                        PRODUTOS_FLOAT: "",
                        TEMPO_ATUALIZACAO_MINUTOS: 5
                    }
                };
                
                database.ref(`performance_mensal/ALPHALUMI/${chavePeriodo}`).update(dadosAtualizados)
                    .then(() => {
                        mostrarStatus(`Período ${chavePeriodo} atualizado com sucesso!`);
                    })
                    .catch((error) => {
                        console.error("Erro ao salvar:", error);
                        mostrarStatus('Erro ao salvar: ' + error.message, true);
                    });
            };

            window.excluirPeriodo = function(chavePeriodo) {
                if (confirm(`Excluir o período ${chavePeriodo}?`)) {
                    database.ref(`performance_mensal/ALPHALUMI/${chavePeriodo}`).remove()
                        .then(() => {
                            mostrarStatus(`Período ${chavePeriodo} excluído com sucesso.`);
                            carregarListaPeriodos();
                        })
                        .catch((error) => {
                            console.error("Erro ao excluir:", error);
                            mostrarStatus('Erro ao excluir: ' + error.message, true);
                        });
                }
            };

            function criarInterfaceNovoPeriodo() {
                const chave = prompt("Chave do período (AAAA_MM):");
                if (!chave || !/^\d{4}_\d{2}$/.test(chave)) {
                    mostrarStatus('Formato inválido. Use AAAA_MM', true);
                    return;
                }
                
                const inicio = prompt("Data INÍCIO (AAAA-MM-DD):");
                const fim = prompt("Data FIM (AAAA-MM-DD):");
                const fim15d = prompt("Data 15D (AAAA-MM-DD):");

                if (!inicio || !fim || !fim15d) {
                    mostrarStatus('Todas as datas são obrigatórias.', true);
                    return;
                }

                const diasUteis = prompt("Dias úteis do período:");
                const produtosFiltro = prompt("Produtos filtro (separados por vírgula):") || "";

                const novoPeriodo = {
                    parametros_do_periodo: {
                        DIA_META_INICIO: inicio,
                        DIA_META_FIM: fim,
                        DIA_META_15D: fim15d,
                        DIAS_UTEIS: parseInt(diasUteis) || 0,
                        PRODUTOS_FILTRO: produtosFiltro,
                        PRODUTOS_FLOAT: "",
                        TEMPO_ATUALIZACAO_MINUTOS: 5
                    }
                };

                database.ref('performance_mensal/ALPHALUMI/' + chave).set(novoPeriodo)
                    .then(() => {
                        mostrarStatus(`Período ${chave} criado com sucesso!`);
                        carregarListaPeriodos();
                    })
                    .catch((error) => {
                        console.error("Erro ao criar:", error);
                        mostrarStatus('Erro: ' + error.message, true);
                    });
            }

            // ==================== ABA 3: EDITOR EM MASSA ====================
            function carregarPeriodosParaDropdown() {
                database.ref('performance_mensal/ALPHALUMI').get().then((snapshot) => {
                    const seletor = document.getElementById('seletorPeriodoEditor');
                    seletor.innerHTML = '<option value="">-- Selecione um período --</option>';
                    
                    if (snapshot.exists()) {
                        const periodos = Object.keys(snapshot.val());
                        periodos.sort().reverse();
                        
                        periodos.forEach(p => {
                            const opcao = document.createElement('option');
                            opcao.value = p;
                            opcao.textContent = p;
                            seletor.appendChild(opcao);
                        });
                    }
                }).catch((error) => {
                    console.error("Erro ao carregar períodos para dropdown:", error);
                });
            }

            window.carregarMetasPeriodo = function() {
                const periodoSelecionado = document.getElementById('seletorPeriodoEditor').value;
                if (!periodoSelecionado) {
                    mostrarStatus('Selecione um período primeiro.', true);
                    return;
                }
                
                console.log("Carregando metas para período:", periodoSelecionado);
                
                // Primeiro carregar a lista de usuários para filtrar por permissão
                database.ref('funcionarios/ALPHALUMI').get().then((usuariosSnapshot) => {
                    const usuarios = usuariosSnapshot.exists() ? usuariosSnapshot.val() : {};
                    
                    // Filtrar IDs de usuários que não são ADM ou GER
                    const idsVendedores = Object.keys(usuarios).filter(userId => {
                        const permissao = usuarios[userId].permissao;
                        return permissao !== 'adm' && permissao !== 'ger';
                    });
                    
                    // Agora carregar dados do período
                    database.ref(`performance_mensal/ALPHALUMI/${periodoSelecionado}`).get().then((snapshot) => {
                        const container = document.getElementById('containerTabelaEditor');
                        
                        if (snapshot.exists()) {
                            const periodoData = snapshot.val();
                            
                            // Filtrar apenas vendedores (não ADM ou GER)
                            const vendedoresComDados = idsVendedores
                                .filter(vendedorKey => periodoData[vendedorKey])
                                .map(vendedorKey => ({
                                    id: vendedorKey,
                                    ...periodoData[vendedorKey],
                                    nome: periodoData[vendedorKey].NOME || usuarios[vendedorKey]?.nome || 'Sem nome'
                                }));
                            
                            if (vendedoresComDados.length === 0) {
                                container.innerHTML = '<div class="alert alert-warning">Nenhum vendedor encontrado para este período.</div>';
                                return;
                            }
                            
                            let html = `
                                <h5>Editando Metas - Período: ${periodoSelecionado}</h5>
                                <div class="table-responsive mt-3">
                                    <table class="table table-dark-custom">
                                        <thead>
                                            <tr>
                                                <th>ID</th>
                                                <th>NOME</th>
                                                <th>META (R$)</th>
                                                <th>META_CLIENTE</th>
                                                <th>META_PRECO (R$)</th>
                                                <th>META_FUME_MAX (R$)</th>
                                                <th>PERCENT_15D</th>
                                                <th>Ações</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tbodyEditor">
                            `;
                            
                            let totalMeta = 0;
                            let totalMetaCliente = 0;
                            let totalMetaPreco = 0;
                            let totalMetaFume = 0;
                            let totalPercent15D = 0;
                            
                            vendedoresComDados.forEach(vendedor => {
                                const meta = vendedor.META || 0;
                                const metaCliente = vendedor.limite_clientes || 0;
                                const metaPreco = vendedor.PRECO_MEDIO || 0;
                                const metaFume = vendedor.META_FUME_MAX || 0;
                                const percent15D = vendedor.PERCENT_15D || 0;
                                
                                totalMeta += meta;
                                totalMetaCliente += metaCliente;
                                totalMetaPreco += metaPreco;
                                totalMetaFume += metaFume;
                                totalPercent15D += percent15D;
                                
                                html += `
                                    <tr id="row-${vendedor.id}">
                                        <td><strong>${vendedor.id}</strong></td>
                                        <td>${vendedor.nome}</td>
                                        <td>
                                            <div class="input-group-prefix">
                                                <span class="prefix">R$</span>
                                                <input type="text" class="form-control form-control-sm money-input-editor" 
                                                    id="${vendedor.id}-META" value="${formatarNumeroParaExibicao(meta)}"
                                                    oninput="calcularTotaisEditor()">
                                            </div>
                                        </td>
                                        <td>
                                            <input type="number" step="1" class="form-control form-control-sm" 
                                                id="${vendedor.id}-META_CLIENTE" value="${metaCliente}"
                                                oninput="calcularTotaisEditor()">
                                        </td>
                                        <td>
                                            <div class="input-group-prefix">
                                                <span class="prefix">R$</span>
                                                <input type="text" class="form-control form-control-sm money-input-editor" 
                                                    id="${vendedor.id}-META_PRECO" value="${formatarNumeroParaExibicao(metaPreco)}"
                                                    oninput="calcularTotaisEditor()">
                                            </div>
                                        </td>
                                        <td>
                                            <div class="input-group-prefix">
                                                <span class="prefix">R$</span>
                                                <input type="text" class="form-control form-control-sm money-input-editor" 
                                                    id="${vendedor.id}-META_FUME_MAX" value="${formatarNumeroParaExibicao(metaFume)}"
                                                    oninput="calcularTotaisEditor()">
                                            </div>
                                        </td>
                                        <td>
                                            <div class="input-group-suffix">
                                                <input type="text" class="form-control form-control-sm percent-input-editor" 
                                                    id="${vendedor.id}-PERCENT_15D" value="${formatarNumeroParaExibicao(percent15D * 100)}"
                                                    oninput="calcularTotaisEditor()">
                                                <span class="suffix">%</span>
                                            </div>
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-success" onclick="salvarVendedor('${periodoSelecionado}', '${vendedor.id}')">
                                                <i class="bi bi-save"></i>
                                            </button>
                                        </td>
                                    </tr>
                                `;
                            });
                            
                            // Linha de totais
                            const mediaPercent15D = vendedoresComDados.length > 0 ? totalPercent15D / vendedoresComDados.length : 0;
                            
                            html += `
                                        </tbody>
                                        <tfoot class="tabela-totalizador">
                                            <tr>
                                                <td colspan="2"><strong>TOTAIS/MÉDIAS:</strong></td>
                                                <td id="totalMeta">${formatarMetaParaExibicao(totalMeta)}</td>
                                                <td id="totalMetaCliente">${totalMetaCliente}</td>
                                                <td id="totalMetaPreco">${formatarMetaParaExibicao(totalMetaPreco)}</td>
                                                <td id="totalMetaFume">${formatarMetaParaExibicao(totalMetaFume)}</td>
                                                <td id="mediaPercent15D">${(mediaPercent15D * 100).toFixed(2).replace('.', ',')}%</td>
                                                <td></td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                                <div class="mt-4 d-flex flex-wrap gap-2">
                                    <button class="btn btn-primary" onclick="salvarTodosVendedores('${periodoSelecionado}')">
                                        <i class="bi bi-save-all"></i> Salvar Todas as Alterações
                                    </button>
                                    <button class="btn btn-outline-secondary" onclick="carregarMetasPeriodo()">
                                        <i class="bi bi-arrow-clockwise"></i> Recarregar
                                    </button>
                                    <button class="btn btn-info" onclick="aplicarMetasPadraoParaTodos('${periodoSelecionado}')">
                                        <i class="bi bi-clipboard-data"></i> Aplicar Metas Padrão a Todos
                                    </button>
                                </div>
                                <div class="mt-3 alert alert-dark border">
                                    <small><strong>Nota:</strong> As alterações são salvas diretamente no Firebase. Use "Recarregar" para ver os valores atuais.</small>
                                </div>
                            `;
                            
                            container.innerHTML = html;
                            
                            // Inicializar máscaras
                            document.querySelectorAll('.money-input-editor').forEach(input => {
                                new Cleave(input, {
                                    numeral: true,
                                    numeralThousandsGroupStyle: 'thousand',
                                    numeralDecimalMark: ',',
                                    delimiter: '.',
                                    numeralDecimalScale: 2,
                                    prefix: '',
                                    rawValueTrimPrefix: true
                                });
                            });
                            
                            document.querySelectorAll('.percent-input-editor').forEach(input => {
                                new Cleave(input, {
                                    numeral: true,
                                    numeralThousandsGroupStyle: 'thousand',
                                    numeralDecimalMark: ',',
                                    delimiter: '.',
                                    numeralDecimalScale: 2,
                                    suffix: '',
                                    rawValueTrimSuffix: true
                                });
                            });
                            
                            mostrarStatus(`Metas de ${vendedoresComDados.length} vendedor(es) carregadas para edição.`);
                            
                        } else {
                            container.innerHTML = '<div class="card-dark p-3"><p class="mb-0 text-center">Nenhum dado encontrado para este período.</p></div>';
                        }
                    });
                }).catch((error) => {
                    console.error("Erro ao carregar metas do período:", error);
                    mostrarStatus('Erro ao carregar: ' + error.message, true);
                });
            };

            window.calcularTotaisEditor = function() {
                const rows = document.querySelectorAll('#tbodyEditor tr');
                let totalMeta = 0;
                let totalMetaCliente = 0;
                let totalMetaPreco = 0;
                let totalMetaFume = 0;
                let totalPercent15D = 0;
                
                rows.forEach(row => {
                    const id = row.id.replace('row-', '');
                    
                    // Usar Cleave para obter o valor numérico
                    const metaInput = document.getElementById(`${id}-META`);
                    const metaPrecoInput = document.getElementById(`${id}-META_PRECO`);
                    const metaFumeInput = document.getElementById(`${id}-META_FUME_MAX`);
                    const percent15DInput = document.getElementById(`${id}-PERCENT_15D`);
                    
                    // Obter valores numéricos dos inputs
                    totalMeta += formatarParaNumero(metaInput.value);
                    totalMetaCliente += parseFloat(document.getElementById(`${id}-META_CLIENTE`).value) || 0;
                    totalMetaPreco += formatarParaNumero(metaPrecoInput.value);
                    totalMetaFume += formatarParaNumero(metaFumeInput.value);
                    totalPercent15D += formatarPercentualParaNumero(percent15DInput.value) / 100;
                });
                
                const mediaPercent15D = rows.length > 0 ? totalPercent15D / rows.length : 0;
                
                // Atualizar totais na tabela
                document.getElementById('totalMeta').textContent = formatarMetaParaExibicao(totalMeta);
                document.getElementById('totalMetaCliente').textContent = totalMetaCliente;
                document.getElementById('totalMetaPreco').textContent = formatarMetaParaExibicao(totalMetaPreco);
                document.getElementById('totalMetaFume').textContent = formatarMetaParaExibicao(totalMetaFume);
                document.getElementById('mediaPercent15D').textContent = (mediaPercent15D * 100).toFixed(2).replace('.', ',') + '%';
            };

            window.salvarVendedor = function(periodo, vendedorKey) {
                const metaInput = document.getElementById(`${vendedorKey}-META`);
                const metaPrecoInput = document.getElementById(`${vendedorKey}-META_PRECO`);
                const metaFumeInput = document.getElementById(`${vendedorKey}-META_FUME_MAX`);
                const percent15DInput = document.getElementById(`${vendedorKey}-PERCENT_15D`);
                
                const dadosAtualizados = {
                    META: formatarParaNumero(metaInput.value),
                    limite_clientes: parseFloat(document.getElementById(`${vendedorKey}-META_CLIENTE`).value) || 0,
                    PRECO_MEDIO: formatarParaNumero(metaPrecoInput.value),
                    META_FUME_MAX: formatarParaNumero(metaFumeInput.value),
                    PERCENT_15D: formatarPercentualParaNumero(percent15DInput.value) / 100
                };
                
                console.log(`Salvando vendedor ${vendedorKey}:`, dadosAtualizados);
                
                database.ref(`performance_mensal/ALPHALUMI/${periodo}/${vendedorKey}`).update(dadosAtualizados)
                    .then(() => {
                        mostrarStatus(`Metas do vendedor ${vendedorKey} salvas com sucesso!`);
                        const linha = document.getElementById(`row-${vendedorKey}`);
                        linha.style.backgroundColor = 'rgba(46, 204, 113, 0.1)';
                        setTimeout(() => { linha.style.backgroundColor = ''; }, 1000);
                    })
                    .catch((error) => {
                        console.error("Erro ao salvar:", error);
                        mostrarStatus('Erro ao salvar: ' + error.message, true);
                    });
            };

            window.salvarTodosVendedores = function(periodo) {
                const periodoSelecionado = periodo || document.getElementById('seletorPeriodoEditor').value;
                if (!periodoSelecionado) return;
                
                const updates = {};
                const linhas = document.querySelectorAll(`#tbodyEditor tr[id^="row-"]`);
                
                if (linhas.length === 0) {
                    mostrarStatus('Nenhum vendedor para salvar.', true);
                    return;
                }
                
                linhas.forEach(linha => {
                    const vendedorKey = linha.id.replace('row-', '');
                    
                    const metaInput = document.getElementById(`${vendedorKey}-META`);
                    const metaPrecoInput = document.getElementById(`${vendedorKey}-META_PRECO`);
                    const metaFumeInput = document.getElementById(`${vendedorKey}-META_FUME_MAX`);
                    const percent15DInput = document.getElementById(`${vendedorKey}-PERCENT_15D`);
                    
                    updates[`performance_mensal/ALPHALUMI/${periodoSelecionado}/${vendedorKey}/META`] = formatarParaNumero(metaInput.value);
                    updates[`performance_mensal/ALPHALUMI/${periodoSelecionado}/${vendedorKey}/limite_clientes`] = parseFloat(document.getElementById(`${vendedorKey}-META_CLIENTE`).value) || 0;
                    updates[`performance_mensal/ALPHALUMI/${periodoSelecionado}/${vendedorKey}/PRECO_MEDIO`] = formatarParaNumero(metaPrecoInput.value);
                    updates[`performance_mensal/ALPHALUMI/${periodoSelecionado}/${vendedorKey}/META_FUME_MAX`] = formatarParaNumero(metaFumeInput.value);
                    updates[`performance_mensal/ALPHALUMI/${periodoSelecionado}/${vendedorKey}/PERCENT_15D`] = formatarPercentualParaNumero(percent15DInput.value) / 100;
                });
                
                console.log("Updates a serem salvos:", updates);
                
                database.ref().update(updates)
                    .then(() => {
                        mostrarStatus(`Todas as metas salvas com sucesso! (${linhas.length} vendedores)`);
                        linhas.forEach(linha => {
                            linha.style.backgroundColor = 'rgba(46, 204, 113, 0.1)';
                            setTimeout(() => { linha.style.backgroundColor = ''; }, 2000);
                        });
                    })
                    .catch((error) => {
                        console.error("Erro ao salvar tudo:", error);
                        mostrarStatus('Erro ao salvar: ' + error.message, true);
                    });
            };

            window.aplicarMetasPadraoParaTodos = function(periodo) {
                if (confirm('Aplicar metas padrão a TODOS os vendedores deste período? Isso substituirá os valores atuais.')) {
                    database.ref(CAMINHO_METAS).get().then((snapshot) => {
                        if (snapshot.exists()) {
                            const metasPadrao = snapshot.val();
                            
                            database.ref(`performance_mensal/ALPHALUMI/${periodo}`).get().then((periodoSnapshot) => {
                                if (periodoSnapshot.exists()) {
                                    const periodoData = periodoSnapshot.val();
                                    const updates = {};
                                    const vendedoresKeys = Object.keys(periodoData).filter(key => 
                                        !isNaN(key) && key !== 'parametros_do_periodo'
                                    );
                                    
                                    vendedoresKeys.forEach(vendedorKey => {
                                        updates[`performance_mensal/ALPHALUMI/${periodo}/${vendedorKey}/META`] = metasPadrao.META || 0;
                                        updates[`performance_mensal/ALPHALUMI/${periodo}/${vendedorKey}/limite_clientes`] = metasPadrao.META_CLIENTE || 0;
                                        updates[`performance_mensal/ALPHALUMI/${periodo}/${vendedorKey}/PRECO_MEDIO`] = metasPadrao.META_PRECO || 0;
                                        updates[`performance_mensal/ALPHALUMI/${periodo}/${vendedorKey}/META_FUME_MAX`] = metasPadrao.META_FUME_MAX || 0;
                                        updates[`performance_mensal/ALPHALUMI/${periodo}/${vendedorKey}/PERCENT_15D`] = metasPadrao.PERCENT_15D || 0;
                                    });
                                    
                                    database.ref().update(updates)
                                        .then(() => {
                                            mostrarStatus(`Metas padrão aplicadas a ${vendedoresKeys.length} vendedor(es)!`);
                                            setTimeout(() => carregarMetasPeriodo(), 500);
                                        })
                                        .catch((error) => {
                                            console.error("Erro ao aplicar metas padrão:", error);
                                            mostrarStatus('Erro ao aplicar: ' + error.message, true);
                                        });
                                }
                            });
                        } else {
                            mostrarStatus('Não há metas padrão definidas.', true);
                        }
                    }).catch((error) => {
                        console.error("Erro ao carregar metas padrão:", error);
                        mostrarStatus('Erro ao carregar metas padrão: ' + error.message, true);
                    });
                }
            };

            // ==================== ABA 4: CONTROLE DE USUÁRIOS ====================
            const CAMINHO_USUARIOS = 'funcionarios/ALPHALUMI';
            let usuariosData = {};
            let senhasResetadas = new Set();
            
            function carregarUsuarios() {
                console.log("Carregando usuários...");
                database.ref(CAMINHO_USUARIOS).get().then((snapshot) => {
                    const tabela = document.getElementById('tabelaUsuarios');
                    
                    if (snapshot.exists()) {
                        usuariosData = snapshot.val();
                        const userIds = Object.keys(usuariosData);
                        
                        if (userIds.length === 0) {
                            tabela.innerHTML = `
                                <tr>
                                    <td colspan="9" class="text-center py-4">
                                        <i class="bi bi-people display-4 text-secondary mb-3"></i>
                                        <p class="mb-0">Nenhum usuário encontrado.</p>
                                    </td>
                                </tr>
                            `;
                            return;
                        }
                        
                        let html = '';
                        userIds.sort((a, b) => parseInt(a) - parseInt(b));
                        
                        userIds.forEach(userId => {
                            const usuario = usuariosData[userId];
                            html += criarLinhaUsuario(userId, usuario);
                        });
                        
                        tabela.innerHTML = html;
                        mostrarStatus(`${userIds.length} usuário(s) carregado(s).`);
                    } else {
                        tabela.innerHTML = `
                            <tr>
                                <td colspan="9" class="text-center py-4">
                                    <i class="bi bi-people display-4 text-secondary mb-3"></i>
                                    <p class="mb-0">Nenhum usuário encontrado no banco de dados.</p>
                                </td>
                            </tr>
                        `;
                    }
                }).catch((error) => {
                    console.error("Erro ao carregar usuários:", error);
                    mostrarStatus('Erro ao carregar usuários: ' + error.message, true);
                    document.getElementById('tabelaUsuarios').innerHTML = `
                        <tr>
                            <td colspan="9" class="text-center py-4 text-danger">
                                <i class="bi bi-exclamation-triangle"></i> Erro ao carregar usuários
                            </td>
                        </tr>
                    `;
                });
            }
            
            function criarLinhaUsuario(userId, usuario) {
                // Determinar classe da tag de permissão
                let permissaoClass = 'permissao-user';
                let permissaoTexto = 'USER';
                
                if (usuario.permissao === 'ger') {
                    permissaoClass = 'permissao-ger';
                    permissaoTexto = 'GER';
                } else if (usuario.permissao === 'adm') {
                    permissaoClass = 'permissao-adm';
                    permissaoTexto = 'ADM';
                }
                
                // Verificar se a senha foi resetada nesta sessão
                const senhaResetada = senhasResetadas.has(userId);
                const btnResetClass = senhaResetada ? 'btn-success active' : 'btn-outline-secondary';
                
                return `
                    <tr id="usuario-row-${userId}" data-userid="${userId}">
                        <td>
                            <img src="${usuario.url_foto || 'https://via.placeholder.com/40x40?text=Sem+foto'}" 
                                 class="avatar" id="avatar-${userId}"
                                 onclick="abrirUploadFoto({id: '${userId}', url_foto: '${usuario.url_foto || ''}'})"
                                 style="cursor: pointer;" title="Clique para alterar foto">
                        </td>
                        <td>
                            <input type="text" class="usuario-input" 
                                   value="${userId}" 
                                   onchange="atualizarUsuarioLocal('${userId}', 'id', this.value)">
                        </td>
                        <td>
                            <input type="text" class="usuario-input" 
                                   value="${usuario.nome || ''}" 
                                   onchange="atualizarUsuarioLocal('${userId}', 'nome', this.value)"
                                   placeholder="Nome completo">
                        </td>
                        <td>
                            <input type="email" class="usuario-input" 
                                   value="${usuario.email || ''}" 
                                   onchange="atualizarUsuarioLocal('${userId}', 'email', this.value)"
                                   placeholder="email@dominio.com" required>
                        </td>
                        <td>
                            <button class="btn btn-sm ${btnResetClass} btn-reset" 
                                    onclick="resetarSenha('${userId}')"
                                    title="Resetar senha para 123456">
                                <i class="bi bi-key"></i> Reset🔑
                            </button>
                        </td>
                        <td>
                            <select class="usuario-select" 
                                    onchange="atualizarUsuarioLocal('${userId}', 'permissao', this.value)">
                                <option value="user" ${usuario.permissao === 'user' ? 'selected' : ''}>USER</option>
                                <option value="ger" ${usuario.permissao === 'ger' ? 'selected' : ''}>GER</option>
                                <option value="adm" ${usuario.permissao === 'adm' ? 'selected' : ''}>ADM</option>
                            </select>
                        </td>
                        <td>
                            <input type="text" class="usuario-input" 
                                   value="${usuario.uf || usuario.estado || ''}" 
                                   onchange="atualizarUsuarioLocal('${userId}', 'uf', this.value)"
                                   placeholder="PR" maxlength="2">
                        </td>
                        <td>
                            <input type="text" class="usuario-input money-input-usuario" 
                                   value="${usuario.meta ? formatarNumeroParaExibicao(usuario.meta) : ''}" 
                                   onchange="atualizarUsuarioLocal('${userId}', 'meta', formatarParaNumero(this.value))"
                                   placeholder="0,00">
                        </td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="salvarUsuarioIndividual('${userId}')">
                                <i class="bi bi-save"></i> Salvar
                            </button>
                        </td>
                    </tr>
                `;
            }
            
            function atualizarUsuarioLocal(userId, campo, valor) {
                if (!usuariosData[userId]) {
                    usuariosData[userId] = {};
                }
                
                // Para o campo ID, precisamos tratar separadamente pois muda a chave
                if (campo === 'id') {
                    if (valor && valor !== userId) {
                        // Criar novo registro com o novo ID
                        usuariosData[valor] = { ...usuariosData[userId] };
                        // Marcar o antigo para exclusão
                        usuariosData[userId].__excluir = true;
                    }
                } else if (campo === 'meta') {
                    usuariosData[userId][campo] = parseFloat(valor) || null;
                } else {
                    usuariosData[userId][campo] = valor || null;
                }
                
                // Marcar como modificado
                usuariosData[userId].__modificado = true;
            }
            
            window.resetarSenha = function(userId) {
                if (usuariosData[userId]) {
                    usuariosData[userId].senha_hash = '123456';
                    usuariosData[userId].__modificado = true;
                    senhasResetadas.add(userId);
                    
                    // Atualizar visual do botão
                    const btn = document.querySelector(`#usuario-row-${userId} .btn-reset`);
                    btn.classList.remove('btn-outline-secondary');
                    btn.classList.add('btn-success', 'active');
                    
                    mostrarStatus(`Senha do usuário ${userId} resetada para "123456"`);
                }
            };
            
            window.salvarUsuarioIndividual = function(userId) {
                if (!usuariosData[userId] || !usuariosData[userId].__modificado) {
                    mostrarStatus('Nenhuma alteração para salvar.', true);
                    return;
                }
                
                const usuario = { ...usuariosData[userId] };
                delete usuario.__modificado;
                delete usuario.__excluir;
                
                // Validar email
                if (usuario.email && !isValidEmail(usuario.email)) {
                    mostrarStatus('Email inválido! Digite um email válido.', true);
                    return;
                }
                
                database.ref(`${CAMINHO_USUARIOS}/${userId}`).update(usuario)
                    .then(() => {
                        mostrarStatus(`Usuário ${usuario.nome || userId} salvo com sucesso!`);
                        usuariosData[userId].__modificado = false;
                        
                        // Se foi reset de senha, manter o botão verde por um tempo
                        if (senhasResetadas.has(userId)) {
                            setTimeout(() => {
                                const btn = document.querySelector(`#usuario-row-${userId} .btn-reset`);
                                if (btn) {
                                    btn.classList.remove('btn-success', 'active');
                                    btn.classList.add('btn-outline-secondary');
                                }
                            }, 3000);
                        }
                    })
                    .catch((error) => {
                        console.error("Erro ao salvar usuário:", error);
                        mostrarStatus('Erro ao salvar usuário: ' + error.message, true);
                    });
            };
            
            window.salvarTodosUsuarios = function() {
                const updates = {};
                const usuariosParaExcluir = [];
                
                // Primeiro, processar exclusões (IDs alterados)
                Object.keys(usuariosData).forEach(oldId => {
                    if (usuariosData[oldId].__excluir) {
                        updates[`${CAMINHO_USUARIOS}/${oldId}`] = null;
                        usuariosParaExcluir.push(oldId);
                    }
                });
                
                // Agora processar atualizações
                Object.keys(usuariosData).forEach(userId => {
                    if (usuariosData[userId].__modificado && !usuariosData[userId].__excluir) {
                        const usuario = { ...usuariosData[userId] };
                        delete usuario.__modificado;
                        delete usuario.__excluir;
                        
                        // Validar email
                        if (usuario.email && !isValidEmail(usuario.email)) {
                            mostrarStatus(`Email inválido para usuário ${userId}: ${usuario.email}`, true);
                            return;
                        }
                        
                        updates[`${CAMINHO_USUARIOS}/${userId}`] = usuario;
                    }
                });
                
                if (Object.keys(updates).length === 0) {
                    mostrarStatus('Nenhuma alteração para salvar.', true);
                    return;
                }
                
                database.ref().update(updates)
                    .then(() => {
                        // Remover excluídos do objeto local
                        usuariosParaExcluir.forEach(id => {
                            delete usuariosData[id];
                        });
                        
                        // Limpar flags de modificação
                        Object.keys(usuariosData).forEach(id => {
                            if (usuariosData[id]) {
                                usuariosData[id].__modificado = false;
                            }
                        });
                        
                        mostrarStatus(`Todos os usuários salvos com sucesso! (${Object.keys(updates).length} alterações)`);
                        
                        // Recarregar a lista para garantir consistência
                        setTimeout(() => carregarUsuarios(), 1000);
                    })
                    .catch((error) => {
                        console.error("Erro ao salvar todos os usuários:", error);
                        mostrarStatus('Erro ao salvar: ' + error.message, true);
                    });
            };
            
            window.criarNovoUsuario = function() {
                // Limpar o formulário
                document.getElementById('novoUsuarioId').value = '';
                document.getElementById('novoUsuarioNome').value = '';
                document.getElementById('novoUsuarioEmail').value = '';
                document.getElementById('novoUsuarioPermissao').value = 'user';
                document.getElementById('novoUsuarioUf').value = '';
                document.getElementById('novoUsuarioMeta').value = '';
                document.getElementById('novoAvatarPreview').src = '';
                document.getElementById('novoAvatarPreview').style.display = 'none';
                document.getElementById('novoAvatarPlaceholder').style.display = 'block';
                arquivoParaUploadNovo = null;
                
                // Configurar máscara para o campo de meta
                const metaInput = document.getElementById('novoUsuarioMeta');
                if (window.novoUsuarioMetaCleave) {
                    window.novoUsuarioMetaCleave.destroy();
                }
                
                window.novoUsuarioMetaCleave = new Cleave(metaInput, {
                    numeral: true,
                    numeralThousandsGroupStyle: 'thousand',
                    numeralDecimalMark: ',',
                    delimiter: '.',
                    numeralDecimalScale: 2,
                    prefix: '',
                    rawValueTrimPrefix: true
                });
                
                const modal = new bootstrap.Modal(document.getElementById('modalNovoUsuario'));
                modal.show();
            };
            
            window.salvarNovoUsuario = function() {
                const userId = document.getElementById('novoUsuarioId').value;
                const nome = document.getElementById('novoUsuarioNome').value;
                const email = document.getElementById('novoUsuarioEmail').value;
                
                if (!userId || !nome || !email) {
                    mostrarStatus('ID, Nome e Email são obrigatórios!', true);
                    return;
                }
                
                if (!isValidEmail(email)) {
                    mostrarStatus('Email inválido! Digite um email válido.', true);
                    return;
                }
                
                const usuario = {
                    nome: nome,
                    email: email,
                    permissao: document.getElementById('novoUsuarioPermissao').value,
                    uf: document.getElementById('novoUsuarioUf').value || null,
                    estado: document.getElementById('novoUsuarioUf').value || null,
                    meta: formatarParaNumero(document.getElementById('novoUsuarioMeta').value) || null,
                    senha_hash: '123456' // Senha padrão
                };
                
                // Primeiro salvar o usuário
                database.ref(`${CAMINHO_USUARIOS}/${userId}`).set(usuario)
                    .then(() => {
                        // Se houver foto para upload, fazer agora
                        if (arquivoParaUploadNovo) {
                            uploadFotoNovoUsuario(userId, arquivoParaUploadNovo)
                                .then(imageUrl => {
                                    if (imageUrl) {
                                        return database.ref(`${CAMINHO_USUARIOS}/${userId}/url_foto`).set(imageUrl);
                                    }
                                })
                                .then(() => {
                                    mostrarStatus(`Usuário ${nome} criado com sucesso!`);
                                    bootstrap.Modal.getInstance(document.getElementById('modalNovoUsuario')).hide();
                                    carregarUsuarios();
                                })
                                .catch(error => {
                                    console.error("Erro ao fazer upload da foto:", error);
                                    mostrarStatus('Usuário criado, mas erro ao fazer upload da foto: ' + error.message, true);
                                    carregarUsuarios();
                                });
                        } else {
                            mostrarStatus(`Usuário ${nome} criado com sucesso!`);
                            bootstrap.Modal.getInstance(document.getElementById('modalNovoUsuario')).hide();
                            carregarUsuarios();
                        }
                    })
                    .catch((error) => {
                        console.error("Erro ao criar usuário:", error);
                        mostrarStatus('Erro ao criar usuário: ' + error.message, true);
                    });
            };
            
            function uploadFotoNovoUsuario(userId, file) {
                return new Promise((resolve, reject) => {
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('upload_preset', 'my_unsigned_preset');
                    formData.append('cloud_name', 'dclhoiqdg');
                    
                    const xhr = new XMLHttpRequest();
                    
                    xhr.addEventListener('load', function() {
                        if (xhr.status === 200) {
                            const response = JSON.parse(xhr.responseText);
                            resolve(response.secure_url);
                        } else {
                            reject(new Error('Erro no upload: ' + xhr.statusText));
                        }
                    });
                    
                    xhr.addEventListener('error', function() {
                        reject(new Error('Erro na conexão com o Cloudinary'));
                    });
                    
                    xhr.open('POST', 'https://api.cloudinary.com/v1_1/dclhoiqdg/image/upload');
                    xhr.send(formData);
                });
            }
            
            window.buscarUsuarios = function() {
                const termo = document.getElementById('inputBuscaUsuario').value.toLowerCase();
                if (!termo) {
                    carregarUsuarios();
                    return;
                }
                
                database.ref(CAMINHO_USUARIOS).get().then((snapshot) => {
                    const tabela = document.getElementById('tabelaUsuarios');
                    
                    if (snapshot.exists()) {
                        usuariosData = snapshot.val();
                        const userIds = Object.keys(usuariosData);
                        
                        let html = '';
                        let encontrados = 0;
                        
                        userIds.forEach(userId => {
                            const usuario = usuariosData[userId];
                            
                            const corresponde = 
                                (usuario.nome && usuario.nome.toLowerCase().includes(termo)) ||
                                (usuario.email && usuario.email.toLowerCase().includes(termo)) ||
                                userId.includes(termo);
                            
                            if (corresponde) {
                                encontrados++;
                                html += criarLinhaUsuario(userId, usuario);
                            }
                        });
                        
                        if (encontrados === 0) {
                            html = `
                                <tr>
                                    <td colspan="9" class="text-center py-4">
                                        <i class="bi bi-search display-4 text-secondary mb-3"></i>
                                        <p class="mb-0">Nenhum usuário encontrado para "${termo}".</p>
                                    </td>
                                </tr>
                            `;
                        }
                        
                        tabela.innerHTML = html;
                        mostrarStatus(`${encontrados} usuário(s) encontrado(s).`);
                    }
                }).catch((error) => {
                    console.error("Erro ao buscar usuários:", error);
                    mostrarStatus('Erro ao buscar usuários: ' + error.message, true);
                });
            };
            
            function isValidEmail(email) {
                const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return re.test(email);
            }

            // ==================== INICIALIZAÇÃO ====================
            console.log("Inicializando aplicação...");
            setTimeout(() => {
                inicializarMascaras();
                carregarMetasPadrao();
                carregarListaPeriodos();
                carregarPeriodosParaDropdown();
                carregarUsuarios();
                
                document.getElementById('aba-usuarios').addEventListener('click', function() {
                    carregarUsuarios();
                });
            }, 1000);
            
        } catch (error) {
            console.error("ERRO CRÍTICO no Firebase:", error);
            document.getElementById('appContainer').innerHTML = 
                '<div class="card-dark p-4"><div class="alert alert-danger">Erro ao conectar ao banco de dados. Verifique o console (F12).</div></div>';
        }

    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
